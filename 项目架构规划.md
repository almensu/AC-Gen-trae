# AC-Gen 项目架构规划

> AC-Gen：空调产品图批量合成生成器
> 类似 Photoshop 图层合成 + Figma 模型实例化批量导出

---

## 一、项目概述

### 1.1 核心目标

基于上传的 PNG 资产（产品图 + 装饰图），通过**元数据标签匹配**规则，自动组合图层并**批量生成**最终合成图。

### 1.2 核心流程

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  产品图上传  │     │  装饰图上传  │     │  组合配置   │     │  批量导出   │
│  (公用资产)  │ ──▶ │  (项目专用)  │ ──▶ │ (标签匹配)  │ ──▶ │  (PNG文件)  │
└─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘
```

### 1.3 关键约束

| 项目 | 规格 |
|------|------|
| 画布尺寸 | 固定 800×800 像素 |
| 资产格式 | PNG（带透明通道） |
| 产品图 | **公用资产库**，可跨项目复用 |
| 装饰图 | **项目专属**，必须绑定 `projectName` |

---

## 二、系统模块设计

```
AC-Gen
├── 📁 组件01: 资产管理 (Asset Library)
│   ├── ProductAsset CRUD（产品图管理）
│   └── DecorationAsset CRUD（装饰图管理）
│
├── 📁 组件02: 项目管理 (Project Manager)
│   ├── 项目创建/编辑/删除
│   └── 项目关联的装饰图列表
│
├── 📁 组件03: 组合配置器 (Composition Builder)
│   ├── 选择项目
│   ├── 勾选产品图（从公用库）
│   ├── 配置机型变量（能效 × 匹数）
│   └── 预览合成效果
│
├── 📁 组件04: 图层合成引擎 (Layer Compositor)
│   ├── 标签匹配逻辑
│   ├── Canvas 图层叠加渲染
│   └── PNG 导出
│
└── 📁 组件05: 批量生成器 (Batch Generator)
    ├── 笛卡尔积计算（产品 × 能效 × 匹数）
    ├── 渲染队列管理
    └── ZIP 打包下载
```

---

## 三、数据模型总览

### 3.1 关系图

```
┌─────────────────────────────────────────────────────────────┐
│                        Project                               │
│  projectName: "haier_2025_q1"                               │
│  canvasWidth: 800                                           │
│  canvasHeight: 800                                          │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌──────────────┐ 1:N  ┌──────────────────────────────────┐ │
│  │ ProductAsset │ ◀──▶ │ DecorationAsset                   │ │
│  │ (公用资产库)  │      │ (项目专属)                        │ │
│  │              │      │ projectName: "haier_2025_q1"      │ │
│  │ energyLevels │      │ energyLevels?: [B1, B3]           │ │
│  │ capacityCodes│      │ capacityCodes?: [26, 35]          │ │
│  └──────────────┘      └──────────────────────────────────┘ │
│         │                        │                          │
│         │                        │                          │
│         ▼                        ▼                          │
│  ┌────────────────────────────────────────────────────────┐ │
│  │               CompositionInput                         │ │
│  │   projectName + productId + energyLevel + capacityCode │ │
│  └────────────────────────────────────────────────────────┘ │
│                          │                                  │
│                          ▼                                  │
│  ┌────────────────────────────────────────────────────────┐ │
│  │               Layer Compositor                         │ │
│  │   匹配装饰图 → 叠加图层 → 输出 PNG                      │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 核心数据类型

```ts
// ========== 基础类型 ==========
type EnergyLevelCode = 'B1' | 'B3';
type CapacityCode = '26' | '35' | '50' | '72' | '100';

// ========== 产品图（公用资产） ==========
type ProductCategory = 'AC' | 'LIFE_APPLIANCE'; // 空调 | 生活电器
type AcFormFactor = 'WALL' | 'CABINET';         // 挂机 | 柜机

type ProductAssetMeta = {
  category: ProductCategory;
  
  // 仅当 category === 'AC' 时必填
  acFormFactor?: AcFormFactor;

  series: string;          // 例如：天丽
  color: string;           // 例如：皓雪白 (原 colorTheme 拆分为 series + color)

  // 适用范围匹配规则：
  // 1. 空调 (AC)：energyLevels 和 capacityCodes 通常必填
  // 2. 生活电器 (LIFE_APPLIANCE)：这两个字段通常为空 (null/undefined)
  energyLevels?: EnergyLevelCode[];
  capacityCodes?: CapacityCode[];
};

type ProductAsset = {
  id: string;
  filePath: string;        // products/天丽_白.png
  meta: ProductAssetMeta;
};

// ========== 装饰图（项目专属） ==========
type DecorationAssetMeta = {
  projectName: string;     // 必填，绑定项目
  category: DecorationCategory;
  energyLevels?: EnergyLevelCode[];
  capacityCodes?: CapacityCode[];
  zIndex?: number;         // 图层顺序
};

type DecorationCategory = 
  | 'BACKGROUND'      // 背景底图
  | 'ENERGY_BADGE'    // 能效角标
  | 'CAPACITY_BADGE'  // 匹数角标
  | 'BRAND_LOGO'      // 品牌Logo
  | 'OTHER';          // 其他装饰 (PNG)

// ========== 价格样式配置 (项目级/模板级) ==========
// 价格不是 PNG 图片，而是渲染的文本图层
type PriceLayerConfig = {
  x: number;
  y: number;
  fontFamily: string;
  fontSize: number;
  color: string;
  projectId: string; // 关联项目
};

type DecorationAsset = {
  id: string;
  filePath: string;
  meta: DecorationAssetMeta;
};

// ========== 项目 ==========
type Project = {
  id: string;
  projectName: string;     // 格力_2025_q1
  displayName: string;     // 格力2025年Q1活动
  canvasWidth: 800;
  canvasHeight: 800;
  createdAt: string;
};

// ========== 组合输入 ==========
type CompositionInput = {
  projectName: string;
  productId: string;
  energyLevel?: EnergyLevelCode;
  capacityCode?: CapacityCode;
  // 可选：动态文本
  priceOriginalText?: string;
  pricePromoText?: string;
};

// ========== 渲染输出 ==========
type CompositionOutput = {
  // 命名规范：<系列>-<形态>-<能效>-<色彩>-<匹数>.png
  // 例：冷静尊-柜机-B1-奢华金-72.png
  // 例：天丽-壁挂-B3-皓雪白-26.png
  fileName: string;
  layers: LayerItem[];
  blob: Blob;
};

type LayerItem = {
  id: string;
  type: 'image' | 'text';
  // image 属性
  assetId?: string;
  filePath?: string;
  // text 属性
  textContent?: string;
  textStyle?: PriceLayerConfig;
  
  zIndex: number;
};
```

---

## 四、图层合成逻辑

### 4.1 图层匹配规则

```ts
function matchDecorations(
  decorations: DecorationAsset[],
  input: CompositionInput
): DecorationAsset[] {
  return decorations.filter(deco => {
    const { projectName, energyLevels, capacityCodes } = deco.meta;
    
    // 1. 必须属于当前项目
    if (projectName !== input.projectName) return false;
    
    // 2. 如果装饰图定义了 energyLevels，检查是否匹配
    if (energyLevels?.length && input.energyLevel) {
      if (!energyLevels.includes(input.energyLevel)) return false;
    }
    
    // 3. 如果装饰图定义了 capacityCodes，检查是否匹配
    if (capacityCodes?.length && input.capacityCode) {
      if (!capacityCodes.includes(input.capacityCode)) return false;
    }
    
    return true;
  });
}
```

### 4.2 图层叠加顺序管理

> **核心原则**：Z-Index 不写死，支持 UI 拖拽排序。

系统应维护一个 **有序图层列表** (Layer List)，渲染时直接按照列表顺序绘制：

1. **默认层级**（初始载入时建议顺序）：
   - Bottom: 背景图
   - Middle: 产品图
   - Top: 装饰图 / 价格文本

2. **用户调整**：
   - 提供类似 PS 的图层面板
   - 支持**鼠标拖拽**调整图层上下顺序 (Drag & Drop Sorting)
   - 调整结果保存到 `Template` 或 `Project` 配置中
```

### 4.3 批量生成示例

```
输入:
  项目: 格力_2025_q1
  产品图: 天丽_皓雪白.png 
     (meta: series="天丽", formFactor="挂机", color="皓雪白", energyLevels=["B3"], capacityCodes=["26", "35"])
  
自动展开:
  CompositionInput[0]: { ..., energyLevel: "B3", capacityCode: "26" }
  CompositionInput[1]: { ..., energyLevel: "B3", capacityCode: "35" }

输出:
  天丽-挂机-B3-皓雪白-26.png
  天丽-挂机-B3-皓雪白-35.png
```

---

## 五、技术栈推荐

### 5.1 总体架构

```
┌─────────────────────────────────────────────────────────────┐
│                        Frontend                              │
│   React 18 + Vite + TypeScript                              │
│   UI: Ant Design 5.x                                        │
│   状态: Zustand                                             │
│   Canvas: Fabric.js (图层管理/预览)                          │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                        Backend                               │
│   Express + TypeScript                                       │
│   文件存储: 本地文件系统 (MVP) / 云存储 (后期)               │
│   数据存储: JSON 文件 (MVP) → SQLite (后期)                  │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 详细技术选型

| 层面 | 技术 | 理由 |
|------|------|------|
| **前端框架** | React 18 + Vite | 生态成熟，开发体验好 |
| **类型系统** | TypeScript | 数据模型复杂，类型安全必要 |
| **UI 组件库** | Ant Design 5.x | 企业级组件丰富，表单/表格完善 |
| **状态管理** | Zustand | 轻量、简洁，适合中型项目 |
| **Canvas 库** | Fabric.js | 成熟的图层管理，支持拖拽/变换 |
| **图片处理** | Sharp (Node) | 高性能 PNG 合成，服务端批量渲染 |
| **后端框架** | Express + TS | 简单灵活，快速开发 |
| **数据存储** | JSON 文件 → SQLite | MVP 阶段用 JSON，后期可迁移 |
| **文件上传** | Multer | Express 标准文件上传中间件 |

### 5.3 项目目录结构

```
AC-Gen/
├── packages/
│   ├── client/                    # 前端 React 应用
│   │   ├── src/
│   │   │   ├── components/
│   │   │   │   ├── AssetLibrary/  # 组件01: 资产管理
│   │   │   │   ├── ProjectManager/# 组件02: 项目管理
│   │   │   │   ├── CompositionBuilder/ # 组件03: 组合配置
│   │   │   │   └── BatchGenerator/# 组件05: 批量生成
│   │   │   ├── hooks/
│   │   │   ├── stores/            # Zustand stores
│   │   │   ├── types/             # TypeScript 类型定义
│   │   │   └── utils/
│   │   └── package.json
│   │
│   ├── server/                    # 后端 Express 应用
│   │   ├── src/
│   │   │   ├── routes/
│   │   │   ├── services/
│   │   │   │   └── compositor.ts  # 组件04: 图层合成引擎
│   │   │   └── utils/
│   │   └── package.json
│   │
│   └── shared/                    # 共享类型定义
│       └── types.ts
│
├── data/                          # JSON 数据存储
│   ├── products.json
│   ├── decorations.json
│   └── projects.json
│
├── storage/                       # 文件存储
│   ├── products/                  # 产品图 PNG
│   ├── decorations/               # 装饰图 PNG (按项目分目录)
│   │   ├── haier_2025_q1/
│   │   └── haier_2025_summer/
│   └── outputs/                   # 合成输出
│
├── docs/                          # 文档
│   ├── 组件01-数据结构.md
│   ├── 组件01-UI CRUD.md
│   └── 项目架构规划.md
│
└── package.json                   # Monorepo 根配置
```

---

## 六、开发路线图

### Phase 1: MVP 基础功能 (1-2周)

- [ ] **组件01: 资产管理**
  - [ ] ProductAsset 上传/列表/删除
  - [ ] DecorationAsset 上传/列表/删除
  - [ ] JSON 元数据编辑表单

- [ ] **组件02: 项目管理**
  - [ ] 项目 CRUD
  - [ ] 项目列表页面

### Phase 2: 核心合成功能 (2-3周)

- [ ] **组件03: 组合配置器**
  - [ ] 选择项目 → 筛选可用装饰图
  - [ ] 勾选产品图（多选）
  - [ ] 配置机型参数（能效/匹数）
  - [ ] 单张预览

- [ ] **组件04: 图层合成引擎**
  - [ ] 标签匹配逻辑
  - [ ] Fabric.js 画布预览
  - [ ] Sharp 服务端渲染

### Phase 3: 批量生成 (1-2周)

- [ ] **组件05: 批量生成器**
  - [ ] 笛卡尔积展开（产品 × 能效 × 匹数）
  - [ ] 批量渲染队列
  - [ ] 进度展示
  - [ ] ZIP 打包下载

### Phase 4: 增强功能 (后续迭代)

- [ ] Canvas 自由编辑模式（拖拽调整位置）
- [ ] 模板保存/加载
- [ ] 动态文本图层（价格等）
- [ ] 历史记录/版本管理
- [ ] SQLite 数据持久化

---

## 七、关键问题 & 设计决策

### Q1: 为什么用 Fabric.js 而不是原生 Canvas？

Fabric.js 提供开箱即用的：
- 图层 z-index 管理
- 对象选择/拖拽/变换
- 序列化/反序列化（方便保存模板）
- 后续扩展自由编辑模式时无需重写

### Q2: 为什么服务端合成用 Sharp 而不是前端 Canvas？

- **性能**：Sharp 基于 libvips，比 Canvas 快 10x
- **批量**：服务端可并行处理，不阻塞 UI
- **一致性**：避免不同浏览器渲染差异
- **资源**：大批量导出不占用用户内存

### Q3: JSON 存储够用吗？

MVP 阶段完全够用：
- 预估资产量：100-500 条
- JSON 读写性能可接受
- 后期如需求扩展（搜索、统计等），迁移到 SQLite 成本低

---

## 八、下一步行动

1. **确认本规划文档**无误
2. 初始化 Monorepo 项目结构
3. 从 **组件01: 资产管理** 开始开发
4. 逐步完成 Phase 1-3

---

## 九、可测试性设计 (Testing Strategy)

为了确保系统的健壮性，我们采用 **"Logic vs UI Separation"** 策略，确保 90% 的核心业务逻辑可以在不启动浏览器/React的情况下进行单元测试。

### 9.1 测试分层策略

| 组件 | 核心逻辑 (Pure TS) | UI 表现 (React) | 测试重点 |
|------|-------------------|----------------|----------|
| **C01/C02 资产管理** | `AssetStore`, `Validator` | `AssetTable`, `UploadForm` | **Unit Test**: 测 Store 的增删改查逻辑、数据验证规则。<br>**Component Test**: 测表单交互。 |
| **C03 组合配置** | `CartesianProductAlgo` | `VariantSelector` | **Unit Test**: 输入[26, 35]能效，断言输出2个变体。逻辑必须是纯函数。 |
| **C04 图层合成** | `LayerMatcher` (Rule Engine) | `CanvasViewer` (Fabric.js) | **Critical**: 将"图层计算"与"Canvas渲染"分离。<br>**Unit Test**: 测 `input -> Layer[]` 的数据转换（匹配规则、排序）。<br>**Visual Test**: 只有渲染部分需要视觉回归测试。 |
| **C05 批量生成** | `FileNameFormatter`, `QueueManager` | `BatchProgress` | **Unit Test**: 测文件名生成逻辑、队列状态流转。 |

### 9.2 关键代码结构示例

为了可测性，**C04 图层合成** 的代码应这样组织：

```ts
// ❌ 错误做法：逻辑耦合在组件里
const CompositionComponent = () => {
   const render = () => {
      if (form.energy === 'B1') canvas.add(badgeB1); // 难以测试
   }
}

// ✅ 正确做法：分离出的纯逻辑 (Easy to Test)
// src/services/compositor/matcher.ts
export function computeLayers(
  assets: DecorationAsset[], 
  input: CompositionInput
): LayerItem[] {
  // 纯逻辑：根据 input 过滤 assets，排序
  // 这里可以写几十个测试用例，覆盖各种边缘情况
  return layers;
}

// UI 组件只负责"画" (Dumb Component)
const CompositionComponent = ({ layers }) => {
   useEffect(() => {
      // 这里的逻辑很简单：拿到 layers 数组，循环添加到 canvas
      deck.render(layers); 
   }, [layers]);
}
```

### 9.3 自动化测试工具链

- **Unit Logic**: `Vitest` (速度快，兼容 Jest)
- **Component DOM**: `React Testing Library`
- **Visual/Canvas**: 建议手动验证 MVP，后期引入 `Playwright` 截图对比。

---

*文档版本: v1.1*  
*最后更新: 2025-12-09*
